<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasar Muamalah - Edisi Dilema Moral</title>
    <style>
        :root { --primary: #2ecc71; --danger: #e74c3c; --dark: #2c3e50; }
        body, html { margin: 0; padding: 0; height: 100%; display: flex; justify-content: center; align-items: center; background-color: #333; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #game-container {
            width: 100vw; height: 177.78vw; max-height: 100vh; max-width: 56.25vh;
            background-image: url('bg_pasar.png'); background-size: cover; background-position: center;
            position: relative; overflow: hidden; display: flex; flex-direction: column;
        }

        #status-bar { position: absolute; top: 10px; width: 90%; left: 5%; display: flex; justify-content: space-between; background: rgba(0,0,0,0.8); color: white; padding: 8px 15px; border-radius: 20px; z-index: 100; font-size: 13px; box-sizing: border-box; border: 1px solid var(--primary); }

        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; }
        .active { display: flex; }

        .speech-bubble { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: white; padding: 15px; border-radius: 15px; width: 80%; border: 3px solid var(--primary); font-weight: bold; text-align: center; z-index: 10; box-shadow: 0 5px 15px rgba(0,0,0,0.2); font-size: 14px; }
        .char-img { position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); height: 90%; z-index: 1; pointer-events: none; }
        
        .tool-section { height: 15%; display: flex; justify-content: center; align-items: center; z-index: 10; margin-top: 80%; }
        .digital-box { background: #222; border: 4px solid #bdc3c7; border-radius: 10px; padding: 10px 20px; color: #0f0; text-align: center; min-width: 150px; }
        #display-val { font-size: 24px; font-family: monospace; }

        .interaction-section { height: 40%; background: rgba(0,0,0,0.6); display: flex; flex-direction: column; align-items: center; z-index: 20; padding: 10px; position: absolute; bottom: 0; width: 100%; box-sizing: border-box;}
        .grid { display: flex; justify-content: center; width: 100%; margin: 5px 0; flex-wrap: wrap; gap: 5px; }
        .card { width: 22%; background: white; border-radius: 8px; padding: 5px; text-align: center; cursor: pointer; border: 3px solid transparent; box-sizing: border-box; }
        .card.selected { border-color: var(--primary); background: #e8f8f0; transform: scale(0.95); }
        .card img { width: 100%; height: 35px; object-fit: contain; }
        .card span { font-size: 8px; font-weight: bold; display: block; color: #333; }

        .btn { padding: 12px 25px; background: var(--primary); color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 500; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; color: white; text-align: center; box-sizing: border-box; }
        #quiz-bg-layer { position: absolute; top:0; left:0; width:100%; height:100%; background-image: url('bg_pasar2.png'); background-size: cover; filter: blur(5px); z-index: 499; display: none; }
        .q-btn { width: 100%; padding: 10px; margin: 4px 0; background: #444; color: white; border: 1px solid #666; border-radius: 8px; cursor: pointer; font-size: 12px; }
        
        #feedback-box { background: white; color: #333; padding: 15px; border-radius: 10px; margin-top: 10px; display: none; border-left: 5px solid var(--primary); }
    </style>
</head>
<body>

<div id="game-container">
    <div id="status-bar">
        <span>Amanah: <b id="val-amanah">100</b></span>
        <span>Berkah: <b id="val-berkah">100</b></span>
    </div>

    <div id="intro-layer" class="layer active">
        <div class="speech-bubble" id="intro-msg">Assalamu'alaikum! Sebelum mulai berdagang, jawablah 5 soal kuis tentang adab jual beli!</div>
        <img src="crt_pedagang1.png" id="intro-char" class="char-img">
        <button class="btn" id="start-quiz-btn" style="position:absolute; bottom:15%; left:50%; transform:translateX(-50%); z-index:100;" onclick="startQuiz()">MULAI KUIS</button>
    </div>

    <div id="game-layer" class="layer">
        <div class="speech-bubble" id="buyer-bubble">...</div>
        <img src="" id="buyer-char" class="char-img">
        <div class="tool-section"><div class="digital-box"><div id="tool-label" style="font-size:10px; color:#aaa;">TIMBANGAN</div><div id="display-val">0.0</div></div></div>
        <div class="interaction-section">
            <div id="payment-info" style="color:white; font-size:11px; margin-bottom:5px; font-weight:bold; display:none; background:rgba(0,0,0,0.5); padding:3px 10px; border-radius:10px;"></div>
            <div class="grid" id="main-grid"></div>
            <button class="btn" id="main-btn" onclick="handleMainAction()">KONFIRMASI</button>
        </div>
    </div>

    <div id="dilemma-overlay" class="overlay">
        <h2 style="color:var(--danger)">Kembalian Kurang!</h2>
        <p id="dilemma-text" style="margin-bottom:10px;"></p>
        <div id="dilemma-options" style="width: 100%;"></div>
        <div id="feedback-box">
            <p id="feedback-text" style="font-size:12px; font-weight:bold;"></p>
            <button class="btn" style="margin-top:5px; padding:5px 15px;" onclick="closeDilemma()">LANJUT</button>
        </div>
    </div>

    <div id="win-overlay" class="overlay">
        <img src="crt_pedagang2.png" style="height: 120%; margin-bottom: -450px;">
        <h2>Alhamdulillah!</h2>
        <p>Kamu berhasil menjadi penjual amanah.</p>
        <div style="background: white; color: black; padding: 10px; border-radius: 10px; margin-top: 0px;">
            <span style="font-size: 11px; color: #666;">PIN LOKASI BERIKUTNYA</span><br>
            <b id="pin-code" style="font-size: 32px; letter-spacing: 5px;">0000</b>
        </div>
	<button class="btn" style="margin-top: 5px; background-color: #2ecc71;" onclick="kirimDataKePeta()">
    	    KEMBALI KE PETA
	</button>
    	</button>
    </div>

    <div id="quiz-bg-layer"></div>
    <div id="quiz-overlay" class="overlay">
        <p id="q-progress" style="color:var(--primary); font-weight:bold;"></p>
        <h3 id="q-text" style="font-size:14px; margin-bottom:15px;"></h3>
        <div id="q-options" style="width: 100%;"></div>
    </div>
</div>

<script>
    /* --- SISTEM AUDIO --- */
    const audio = {
    	bgm: new Audio('bgm_game.mp3'),
    	benar: new Audio('benar.mp3'),
    	salah: new Audio('salah.mp3'),
    	menang: new Audio('menang.mp3'),
    	salamPria: new Audio('salam_pria.mp3'),
    	salamWanita: new Audio('salam_wanita.mp3')
    };
    audio.bgm.loop = true;
    audio.bgm.volume = 0.4;

    let amanah = 100, berkah = 100, currentQ = 0, shuffledQuiz = [];
    let phase = "SCALE", targetW = 0, currentW = 0, price = 0, buyerPay = 0, currentChange = 0;
    const products = [{n:"Apel", i:"apel.png"}, {n:"Beras", i:"beras.png"}, {n:"Jeruk", i:"jeruk.png"}];
    const buyers = ["crt_laki.png", "crt_perempuan.png", "crt_bapak.png"];

    const rawQuiz = [
        { q: "Sifat pribadi yang dapat dipercaya dalam bertransaksi jual beli antara lain ditandai dengan...", a: ["Menipu harga dan berat barang", "Menyembunyikan cacat barang dari pembeli", "Jujur dalam menyampaikan kualitas dan harga barang", "Memaksa pembeli untuk membeli barang"], c: "Jujur dalam menyampaikan kualitas dan harga barang" },
        { q: "Perilaku yang tidak sesuai dengan prinsip kejujuran dalam jual beli adalah...", a: ["Memberikan informasi yang jelas tentang barang yang dijual", "Menyesuaikan berat barang dengan yang telah disepakati", "Menambah beban berat dengan cara memasang timbangan yang tidak akurat", "Memberikan diskon kepada pembeli secara adil"], c: "Menambah beban berat dengan cara memasang timbangan yang tidak akurat" },
        { q: "Rukun jual beli terdiri dari...", a: ["Penjual dan pembeli", "Akad dan objek yang di jual belikan", "Penjual, Pembeli, Objek, Akad jual bel", "Transaksi jual beli, waktu, tempat"], c: "Penjual, Pembeli, Objek, Akad jual bel" },
        { q: "Doni membeli 3kg buah apel... saat di rumah ada beberapa yang rusak. Ia meminta pengurangan harga. Kejadian tersebut termasuk...", a: ["Khiyar Majelis", "Khiyar Syarat", "Khiyar 'aibi"], c: "Khiyar 'aibi" },
        { q: "Pak Andi sepakat menjual laptop... hilang dicuri tanpa kelalaian. Bagaimana statusnya?", a: ["Transaksi dianggap batal demi hukum, dan DP kembali", "Wajib ganti laptop baru", "Budi tetap wajib melunasi", "Pak Andi tidak perlu kembalikan DP"], c: "Transaksi dianggap batal demi hukum, dan DP kembali" }
    ];

    function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

    function startQuiz() {
        shuffledQuiz = shuffle([...rawQuiz]);
        document.getElementById('quiz-bg-layer').style.display = 'block';
        document.getElementById('quiz-overlay').style.display = 'flex';
        renderQuestion();
	audio.bgm.play().catch(e => console.log(e)); // PLAY MUSIK
    }

    function renderQuestion() {
        let q = shuffledQuiz[currentQ];
        document.getElementById('q-progress').innerText = `Kuis: ${currentQ + 1}/5`;
        document.getElementById('q-text').innerText = q.q;
        const optBox = document.getElementById('q-options');
        optBox.innerHTML = '';
        shuffle([...q.a]).forEach(opt => {
            const b = document.createElement('button'); b.className = 'q-btn'; b.innerText = opt;
            b.onclick = () => {
                if (opt === q.c) {
                    // --- SUARA JAWABAN BENAR ---
                    audio.benar.currentTime = 0;
                    audio.benar.play();
                    
                    currentQ++;
                    if (currentQ < 5) renderQuestion();
                    else showPedagangSuccess();
                } else {
                    // --- SUARA JAWABAN SALAH ---
                    audio.salah.currentTime = 0;
                    audio.salah.play();
                    
                    // Beri jeda sedikit sebelum alert agar suara terdengar
                    setTimeout(() => {
                        alert("Salah! Adab adalah utama dalam dagang. Ulangi kuis!");
                        location.reload();
                    }, 500); 
                }
            };
            optBox.appendChild(b);
        });
    }

    function showPedagangSuccess() {
        document.getElementById('quiz-overlay').style.display = 'none';
        document.getElementById('quiz-bg-layer').style.display = 'none';
        document.getElementById('intro-char').src = 'crt_pedagang2.png';
        document.getElementById('intro-msg').innerText = "Selamat kamu berhasil! Silahkan lanjut ke jual beli.";
        document.getElementById('start-quiz-btn').innerText = "MULAI DAGANG";
        document.getElementById('start-quiz-btn').onclick = () => {
            document.getElementById('intro-layer').classList.remove('active');
            document.getElementById('game-layer').classList.add('active');
            startNewCustomer();
        };
    }

    function startNewCustomer() {
        if (amanah >= 140 && berkah >= 100) { showWin(); return; }
        phase = "SCALE"; currentW = 0;
        let p = products[Math.floor(Math.random() * products.length)];
        const chosenBuyer = buyers[Math.floor(Math.random() * buyers.length)];
        document.getElementById('buyer-char').src = chosenBuyer;

        if (chosenBuyer.includes('laki') || chosenBuyer.includes('bapak')) {
            audio.salamPria.currentTime = 0; 
            audio.salamPria.play().catch(e => console.log("Gagal putar suara pria", e));
    	} else {
            audio.salamWanita.currentTime = 0;
            audio.salamWanita.play().catch(e => console.log("Gagal putar suara wanita", e));
    	}
	targetW = [0.9, 1.3, 1.6, 0.7][Math.floor(Math.random() * 3)];
        price = targetW * 15000;
        document.getElementById('buyer-bubble').innerText = `Saya mau beli ${targetW}kg ${p.n}.`;
        document.getElementById('tool-label').innerText = "TIMBANGAN";
        document.getElementById('display-val').innerText = "0.0";
        document.getElementById('payment-info').style.display = "none";
        const grid = document.getElementById('main-grid'); grid.innerHTML = '';
        [1.0, 0.5, 0.2, 0.2].forEach(w => {
            const c = document.createElement('div'); c.className = 'card';
            c.innerHTML = `<img src="${p.i}"><span>${w}kg</span>`;
            c.onclick = () => {
                if(c.classList.contains('selected')) { c.classList.remove('selected'); currentW -= w; }
                else { c.classList.add('selected'); currentW += w; }
                document.getElementById('display-val').innerText = currentW.toFixed(1);
            };
            grid.appendChild(c);
        });
    }

    function initPayment() {
        phase = "CASH"; currentChange = 0;
        const grid = document.getElementById('main-grid'); grid.innerHTML = '';
        buyerPay = Math.ceil(price / 1000) * 1220 ;
        let realChange = buyerPay - price;
        document.getElementById('tool-label').innerText = "TOTAL KEMBALIAN";
        document.getElementById('display-val').innerText = "Rp0";
        document.getElementById('payment-info').style.display = "block";
        document.getElementById('payment-info').innerText = `KEMBALIAN HARUS: Rp${realChange.toLocaleString()}`;
        document.getElementById('buyer-bubble').innerText = `Total Rp${price.toLocaleString()}. Uang saya Rp${buyerPay.toLocaleString()}.`;
        [5000, 2000, 1000].forEach(v => {
            const c = document.createElement('div'); c.className = 'card';
            c.innerHTML = `<img src="${v}.png"><span>Rp${v}</span>`;
            c.onclick = () => {
                if(c.classList.contains('selected')) { c.classList.remove('selected'); currentChange -= v; }
                else { c.classList.add('selected'); currentChange += v; }
                document.getElementById('display-val').innerText = `Rp${currentChange.toLocaleString()}`;
            };
            grid.appendChild(c);
        });
    }

    function handleMainAction() {
        if (phase === "SCALE") {
            let fw = parseFloat(currentW.toFixed(1));
            if (fw === targetW) amanah += 10;
            else if (fw < targetW) { amanah -= 20; alert("Kurang timbangan! Amanah turun."); }
            else { berkah += 15; alert("Sedekah timbangan! Berkah naik."); }
            updateStatus(); initPayment();
        } else {
            let target = buyerPay - price;
            if (currentChange === target) { amanah += 10; berkah += 5; alert("Tepat!"); startNewCustomer(); }
            else if (currentChange < target) showDilema(target - currentChange);
            else { amanah += 15; berkah += 20; alert("Kembalian lebih (sedekah)! Poin naik."); startNewCustomer(); }
            updateStatus();
        }
    }

    function showDilema(kurang) {
        const overlay = document.getElementById('dilemma-overlay');
        overlay.style.display = 'flex';
        document.getElementById('feedback-box').style.display = 'none';
        document.getElementById('dilemma-options').style.display = 'block';
        document.getElementById('dilemma-text').innerText = `Kembalian kurang Rp${kurang.toLocaleString()}. Apa tindakanmu?`;
        
        const optBox = document.getElementById('dilemma-options');
        optBox.innerHTML = '';
        
        const options = [
            {t: "Ganti Permen", a:-15, b:2, f: "Feedback: Permen bukan uang. Secara syariah, kembalian harus dengan alat tukar yang disepakati atau diikhlaskan. Amanah turun!"},
            {t: "Minta Maaf Saja", a:5, b:-10, f: "Feedback: Jujur itu baik, tapi pembeli tetap rugi materi. Amanah naik sedikit karena jujur, tapi Berkah turun."},
            {t: "Catat Jadi Tabungan", a:20, b:10, f: "Feedback: Ini paling amanah! Menjaga hak pembeli untuk transaksi berikutnya. Amanah dan Berkah naik!"}
        ];

        options.forEach(o => {
            const b = document.createElement('button');
            b.className = 'q-btn'; b.innerText = o.t;
            b.onclick = () => {
                amanah += o.a; berkah += o.b; updateStatus();
                document.getElementById('dilemma-options').style.display = 'none';
                document.getElementById('feedback-box').style.display = 'block';
                document.getElementById('feedback-text').innerText = o.f;
            };
            optBox.appendChild(b);
        });
    }

    function closeDilemma() {
        document.getElementById('dilemma-overlay').style.display = 'none';
        startNewCustomer();
    }

    function showWin() {
        document.getElementById('win-overlay').style.display = 'flex';
        // Simpan PIN yang digenerate agar bisa dikirim
        const generatedPin = Math.floor(1000 + Math.random() * 9000);
        document.getElementById('pin-code').innerText = generatedPin;
        
        // Simpan PIN di variabel global agar bisa diakses tombol kembali
        window.generatedPin = generatedPin.toString(); 
    }

   // Fungsi lokal untuk mengirim data ke index.html
   function kirimDataKePeta() {
    	// Ambil PIN yang sedang tampil
    	const currentPin = document.getElementById('pin-code').innerText;
    
    	// Kirim pesan ke parent (index.html)
    	window.parent.postMessage({
       	    type: 'FINISH_PASAR', // Tipe pesan ini harus sesuai dengan yang ditangkap index.html
            amanah: amanah,
            berkah: berkah,
            pin: currentPin
    	}, '*');
    }

    function updateStatus() {
        document.getElementById('val-amanah').innerText = amanah;
        document.getElementById('val-berkah').innerText = berkah;
    }
</script>
</body>
</html>
